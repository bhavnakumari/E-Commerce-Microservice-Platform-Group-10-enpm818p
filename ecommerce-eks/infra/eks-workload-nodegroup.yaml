AWSTemplateFormatVersion: '2010-09-09'
Description: Workload NodeGroup for application microservices.

Parameters:

  ClusterName:
    Type: String
    Default: ecommerce-eks-cluster

  NodeGroupName:
    Type: String
    Default: workload-ng

  InstanceType:
    Type: String
    Default: t3.medium

  DesiredCapacity:
    Type: Number
    Default: 3

  MinSize:
    Type: Number
    Default: 3

  MaxSize:
    Type: Number
    Default: 6

  PrivateSubnet1:
    Type: AWS::EC2::Subnet::Id

  PrivateSubnet2:
    Type: AWS::EC2::Subnet::Id

  NodeSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id


Resources:

  NodeInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ClusterName}-workload-node-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore

  WorkloadLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${NodeGroupName}-lt"
      LaunchTemplateData:
        InstanceType: !Ref InstanceType
        SecurityGroupIds:
          - !Ref NodeSecurityGroupId

        BlockDeviceMappings:
          - DeviceName: "/dev/xvda"
            Ebs:
              VolumeSize: 30
              VolumeType: gp3

        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${ClusterName}-workload-node"
              - Key: node-type
                Value: workload
              - Key: environment
                Value: production
              - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
                Value: owned
              - Key: !Sub "k8s.io/cluster-autoscaler/${ClusterName}"
                Value: owned
              - Key: "k8s.io/cluster-autoscaler/enabled"
                Value: "true"

  WorkloadNodeGroup:
    Type: AWS::EKS::Nodegroup
    Properties:
      ClusterName: !Ref ClusterName
      NodegroupName: !Ref NodeGroupName
      NodeRole: !GetAtt NodeInstanceRole.Arn

      ScalingConfig:
        MinSize: !Ref MinSize
        DesiredSize: !Ref DesiredCapacity
        MaxSize: !Ref MaxSize

      Subnets:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

      LaunchTemplate:
        Id: !Ref WorkloadLaunchTemplate
        Version: !GetAtt WorkloadLaunchTemplate.LatestVersionNumber

      Tags:
        node-type: workload
        environment: production

Outputs:
  WorkloadNodeGroupName:
    Value: !Ref WorkloadNodeGroup
    Export:
      Name: WorkloadNodeGroupName

  WorkloadNodeRoleArn:
    Value: !GetAtt NodeInstanceRole.Arn
    Export:
      Name: WorkloadNodeInstanceRoleArn
