name: Build & Deploy to EKS (main)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-push-deploy:
    runs-on: self-hosted

    env:
      # from GitHub Variables
      AWS_REGION: ${{ vars.AWS_REGION }}
      EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }}
      K8S_NAMESPACE: ${{ vars.K8S_NAMESPACE }}
      ECR_ACCOUNT_ID: ${{ vars.ECR_ACCOUNT_ID }}
      ECR_REGISTRY: ${{ vars.ECR_REGISTRY }}
      IMAGE_TAG: ${{ github.sha }}

      # DB config (from GitHub Variables)
      MYSQL_HOST: ${{ vars.MYSQL_HOST }}   # e.g. "mysql"
      MYSQL_DB: ${{ vars.MYSQL_DB }}       # e.g. "shop"

      # DB credentials (from GitHub Secrets)
      MYSQL_USER: ${{ secrets.MYSQL_USER }}          # e.g. "shop"
      MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}  # real password


      # Mongo config (from GitHub Variables)
      MONGO_URI: ${{ vars.MONGO_URI }}
      MONGO_DB: ${{ vars.MONGO_DB }}
      MONGO_PRODUCTS_COLLECTION: ${{ vars.MONGO_PRODUCTS_COLLECTION }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show AWS identity (sanity check)
        run: aws sts get-caller-identity

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_REGISTRY"

      # ========= BUILD & PUSH IMAGES =========

      - name: Build & push products service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-products:$IMAGE_TAG"
          docker build -t "$IMAGE" services/products
          docker push "$IMAGE"

      - name: Build & push users service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-users:$IMAGE_TAG"
          docker build -t "$IMAGE" services/users-java
          docker push "$IMAGE"

      - name: Build & push inventory service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-inventory:$IMAGE_TAG"
          docker build -t "$IMAGE" services/inventory
          docker push "$IMAGE"

      - name: Build & push orders service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-orders:$IMAGE_TAG"
          docker build -t "$IMAGE" services/orders-java
          docker push "$IMAGE"

      - name: Build & push payments service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-payments:$IMAGE_TAG"
          docker build -t "$IMAGE" services/payments
          docker push "$IMAGE"

      - name: Build & push storefront service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-storefront:$IMAGE_TAG"
          docker build -t "$IMAGE" services/storefront
          docker push "$IMAGE"

      # ========= SECURITY SCAN (TRIVY) =========
      - name: Scan images with Trivy (fail on CRITICAL/HIGH)
        run: |
          SERVICES=("products" "users" "inventory" "orders" "payments" "storefront")

          for svc in "${SERVICES[@]}"; do
            IMAGE="$ECR_REGISTRY/ecommerce-$svc:$IMAGE_TAG"
            echo "Scanning image: $IMAGE"

            docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              aquasec/trivy:latest \
              image \
                --severity CRITICAL \
                --exit-code 1 \
                --no-progress \
                "$IMAGE"
          done

      # ========= CONFIGURE KUBECTL =========

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --region "$AWS_REGION" --name "$EKS_CLUSTER_NAME"
          kubectl get nodes

      # ========= APPLY DB CONFIGMAP + SECRET =========

      - name: Apply DB ConfigMap (shop-config)
        run: |
          kubectl -n "$K8S_NAMESPACE" create configmap shop-config \
            --from-literal=MYSQL_HOST="${MYSQL_HOST}" \
            --from-literal=MYSQL_DB="${MYSQL_DB}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply MySQL credentials Secret (mysql-credentials)
        run: |
          kubectl -n "$K8S_NAMESPACE" create secret generic mysql-credentials \
            --from-literal=MYSQL_USER="${MYSQL_USER}" \
            --from-literal=MYSQL_PASSWORD="${MYSQL_PASSWORD}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Mongo ConfigMap (mongo-config)
        run: |
          kubectl -n "$K8S_NAMESPACE" create configmap mongo-config \
            --from-literal=MONGO_URI="${MONGO_URI}" \
            --from-literal=MONGO_DB="${MONGO_DB}" \
            --from-literal=MONGO_PRODUCTS_COLLECTION="${MONGO_PRODUCTS_COLLECTION}" \
            --dry-run=client -o yaml | kubectl apply -f -

      # ========= DEPLOY / UPDATE IMAGES IN EKS =========

      - name: Update deployments with new images
        run: |
          kubectl -n "$K8S_NAMESPACE" set image deployment/products-deployment \
            products="$ECR_REGISTRY/ecommerce-products:$IMAGE_TAG"

          kubectl -n "$K8S_NAMESPACE" set image deployment/users-deployment \
            users="$ECR_REGISTRY/ecommerce-users:$IMAGE_TAG"

          kubectl -n "$K8S_NAMESPACE" set image deployment/inventory-deployment \
            inventory="$ECR_REGISTRY/ecommerce-inventory:$IMAGE_TAG"

          kubectl -n "$K8S_NAMESPACE" set image deployment/orders-deployment \
            orders="$ECR_REGISTRY/ecommerce-orders:$IMAGE_TAG"

          kubectl -n "$K8S_NAMESPACE" set image deployment/payments-deployment \
            payments="$ECR_REGISTRY/ecommerce-payments:$IMAGE_TAG"

          kubectl -n "$K8S_NAMESPACE" set image deployment/storefront-deployment \
            storefront="$ECR_REGISTRY/ecommerce-storefront:$IMAGE_TAG"

      - name: Wait for rollouts
        run: |
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/products-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/users-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/inventory-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/orders-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/payments-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/storefront-deployment