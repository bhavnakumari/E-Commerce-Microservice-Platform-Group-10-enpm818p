name: Build & Deploy to EKS (main)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-push-deploy:
    runs-on: [ self-hosted, bastion ]   # uses your Bastion runner

    env:
      AWS_REGION: us-east-1
      EKS_CLUSTER_NAME: ecommerce-eks-cluster
      K8S_NAMESPACE: shop               # IMPORTANT: matches your overlay namespace
      ECR_ACCOUNT_ID: "361769595099"    # your AWS account ID
      ECR_REGISTRY: "361769595099.dkr.ecr.us-east-1.amazonaws.com"
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show AWS identity (sanity check)
        run: aws sts get-caller-identity

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_REGISTRY"

      # ========= BUILD & PUSH IMAGES (from docker-compose build contexts) =========

      # products service
      - name: Build & push products service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-products:$IMAGE_TAG"
          docker build -t "$IMAGE" services/products
          docker push "$IMAGE"

      # users service
      - name: Build & push users service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-users:$IMAGE_TAG"
          docker build -t "$IMAGE" services/users-java
          docker push "$IMAGE"

      # inventory service
      - name: Build & push inventory service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-inventory:$IMAGE_TAG"
          docker build -t "$IMAGE" services/inventory
          docker push "$IMAGE"

      # orders service
      - name: Build & push orders service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-orders:$IMAGE_TAG"
          docker build -t "$IMAGE" services/orders-java
          docker push "$IMAGE"

      # payments service
      - name: Build & push payments service
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-payments:$IMAGE_TAG"
          docker build -t "$IMAGE" services/payments
          docker push "$IMAGE"

      # storefront (React + Nginx)
      - name: Build & push storefront image
        run: |
          cd ecommerce-eks
          IMAGE="$ECR_REGISTRY/ecommerce-storefront:$IMAGE_TAG"
          docker build -t "$IMAGE" services/storefront
          docker push "$IMAGE"

      # ========= CONFIGURE KUBECTL =========

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --region "$AWS_REGION" --name "$EKS_CLUSTER_NAME"
          kubectl get nodes

      # ========= DEPLOY / UPDATE IMAGES IN EKS =========
      # deployment names MUST match what you have in k8s/base/*.yaml

      - name: Update deployments with new images
        run: |
          # products
          kubectl -n "$K8S_NAMESPACE" set image deployment/products-deployment \
            products="$ECR_REGISTRY/ecommerce-products:$IMAGE_TAG"

          # users
          kubectl -n "$K8S_NAMESPACE" set image deployment/users-deployment \
            users="$ECR_REGISTRY/ecommerce-users:$IMAGE_TAG"

          # inventory
          kubectl -n "$K8S_NAMESPACE" set image deployment/inventory-deployment \
            inventory="$ECR_REGISTRY/ecommerce-inventory:$IMAGE_TAG"

          # orders
          kubectl -n "$K8S_NAMESPACE" set image deployment/orders-deployment \
            orders="$ECR_REGISTRY/ecommerce-orders:$IMAGE_TAG"

          # payments
          kubectl -n "$K8S_NAMESPACE" set image deployment/payments-deployment \
            payments="$ECR_REGISTRY/ecommerce-payments:$IMAGE_TAG"
          
          # storefront
          kubectl -n "$K8S_NAMESPACE" set image deployment/storefront-deployment \
            storefront="$ECR_REGISTRY/ecommerce-storefront:$IMAGE_TAG"

      - name: Wait for rollouts
        run: |
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/products-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/users-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/inventory-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/orders-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/payments-deployment
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/storefront-deployment   
